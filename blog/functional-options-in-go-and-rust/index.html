<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Functional Options in Go and Rust | roessland's blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The Functional Options Pattern is a safer alternative to struct literals, and is commonly used in Go. These are the challenges I encountered when trying it out in Rust."><meta name=generator content="Hugo 0.110.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.98b8feee71ad3d56ea881041d877c631e7268369636aa10acbcb1c7f3bd3ea41.css><meta property="og:title" content="Functional Options in Go and Rust"><meta property="og:description" content="The Functional Options Pattern is a safer alternative to struct literals, and is commonly used in Go. These are the challenges I encountered when trying it out in Rust."><meta property="og:type" content="article"><meta property="og:url" content="https://www.roessland.com/blog/functional-options-in-go-and-rust/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-03T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-03T00:00:00+00:00"><meta itemprop=name content="Functional Options in Go and Rust"><meta itemprop=description content="The Functional Options Pattern is a safer alternative to struct literals, and is commonly used in Go. These are the challenges I encountered when trying it out in Rust."><meta itemprop=datePublished content="2023-06-03T00:00:00+00:00"><meta itemprop=dateModified content="2023-06-03T00:00:00+00:00"><meta itemprop=wordCount content="2438"><meta itemprop=keywords content="go,rust,programming,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Functional Options in Go and Rust"><meta name=twitter:description content="The Functional Options Pattern is a safer alternative to struct literals, and is commonly used in Go. These are the challenges I encountered when trying it out in Rust."><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.13.4/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>window.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByClassName("language-mermaid");for(let t of e){let n=t.parentElement;n.before(t),n.remove()}mermaid.init(void 0,".language-mermaid")}),MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">roessland's blog</a><div class="flex-l items-center"><div class=ananke-socials><a href=https://github.com/roessland target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg enable-background="new 0 0 512 512" height="50" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">BLOGS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Functional Options in Go and Rust</h1><p class=tracked>By <strong>Andreas Røssland</strong></p><time class="f6 mv4 dib tracked" datetime=2023-06-03T00:00:00Z>June 3, 2023</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p><a href=https://www.reddit.com/r/learnrust/comments/13zhnjj/functional_options_pattern_in_go_and_rust/>Comments</a></p><p>The <a href=https://dave.cheney.net/2016/11/13/do-not-fear-first-class-functions>Functional Options Pattern</a> is often used to create objects in Go. It&rsquo;s a good middle ground between the simplicity of <a href=https://go.dev/tour/moretypes/5>struct literals</a> and the safety/usability of the <a href=https://en.wikipedia.org/wiki/Builder_pattern>Builder Pattern</a>. But how do I implement it in Rust? These are my notes as a professional Gopher and a novice Crustacean.</p><p><em>Disclaimer:</em> The Rust code below was intentionally written without researching Rust idioms or patterns.</p><h2 id=creating-objects-in-go>Creating objects in Go</h2><p>Just using struct literals is a great way to construct objects in Go. It&rsquo;s only when you need additional safety and the number of arguments is getting unwieldy that you would need something more complex.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>type</span> <span style=color:#babbf1>Person</span> <span style=color:#ca9ee6>struct</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>FirstName</span> <span style=color:#e5c890>string</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>LastName</span>  <span style=color:#e5c890>string</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#626880;font-style:italic>// Usage:
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#babbf1>person</span> <span style=color:#99d1db>:=</span> <span style=color:#99d1db>&amp;</span><span style=color:#babbf1>Person</span><span style=color:#c6d0f5>{</span><span style=color:#babbf1>FirstName</span><span style=color:#c6d0f5>:</span> <span style=color:#a6d189>&#34;John&#34;</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>LastName</span><span style=color:#c6d0f5>:</span> <span style=color:#a6d189>&#34;Doe&#34;</span><span style=color:#c6d0f5>}</span>
</span></span></code></pre></div><p>For example, if you need to validate the struct fields, or the fields are private. The next level of safety and complexity is a constructor. Like in Rust, constructors in Go are just ordinary functions that return your type, or a pointer to your type. They are conventionally named <code>NewSomething</code>.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>package</span> <span style=color:#babbf1>person</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>type</span> <span style=color:#babbf1>Person</span> <span style=color:#ca9ee6>struct</span> <span style=color:#c6d0f5>{</span>  
</span></span><span style=display:flex><span>	<span style=color:#babbf1>firstName</span> <span style=color:#e5c890>string</span>  
</span></span><span style=display:flex><span>	<span style=color:#babbf1>lastName</span> <span style=color:#e5c890>string</span>  
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>func</span> <span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>firstName</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>lastName</span> <span style=color:#e5c890>string</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>(</span><span style=color:#99d1db>*</span><span style=color:#babbf1>Person</span><span style=color:#c6d0f5>,</span> <span style=color:#e5c890>error</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>person</span> <span style=color:#99d1db>:=</span> <span style=color:#99d1db>&amp;</span><span style=color:#babbf1>Person</span><span style=color:#c6d0f5>{</span><span style=color:#babbf1>firstName</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>lastName</span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>if</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>:=</span> <span style=color:#99d1db>validatePerson</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>person</span><span style=color:#c6d0f5>);</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>!=</span> <span style=color:#ca9ee6;font-style:italic>nil</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#ca9ee6>return</span> <span style=color:#ca9ee6;font-style:italic>nil</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>err</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>return</span> <span style=color:#babbf1>person</span><span style=color:#c6d0f5>,</span> <span style=color:#ca9ee6;font-style:italic>nil</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#626880;font-style:italic>// Usage::
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#ca9ee6>package</span> <span style=color:#babbf1>person_test</span>
</span></span><span style=display:flex><span><span style=color:#babbf1>p</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>:=</span> <span style=color:#babbf1>person</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;John&#34;</span><span style=color:#c6d0f5>,</span> <span style=color:#a6d189>&#34;Doe&#34;</span><span style=color:#c6d0f5>)</span>
</span></span></code></pre></div><p>A constructor like this is usually good enough, but there are arguments for using a more complex pattern: Having a large constructor can be error-prone if types are similar and there are many arguments, as some of them can be switched around without any compiler warnings. Adding additional arguments will also require all usages to be modified.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#626880;font-style:italic>// These are equally valid. Compiler doesn&#39;t catch this.
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#babbf1>person</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>input</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>firstName</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>input</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>lastName</span><span style=color:#c6d0f5>)</span>
</span></span><span style=display:flex><span><span style=color:#babbf1>person</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>input</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>lastName</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>input</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>firstName</span><span style=color:#c6d0f5>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#626880;font-style:italic>// It&#39;s not possible to combine arguments
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#babbf1>person</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>myDefaultPerson</span><span style=color:#c6d0f5>)</span>
</span></span></code></pre></div><p>To justify a more complex pattern I will use a slightly more complex type.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>package</span> <span style=color:#babbf1>monitor</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>type</span> <span style=color:#babbf1>Resolution</span> <span style=color:#ca9ee6>struct</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>Width</span>  <span style=color:#e5c890>int</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>Height</span> <span style=color:#e5c890>int</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>type</span> <span style=color:#babbf1>Monitor</span> <span style=color:#ca9ee6>struct</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>tech</span>       <span style=color:#e5c890>string</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>resolution</span> <span style=color:#babbf1>Resolution</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>hasStand</span>   <span style=color:#e5c890>bool</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span></code></pre></div><p>The use case here is to always be certain that a non-nil Monitor is valid whenever used outside the package. Because of this, all fields must be private to ensure other packages cannot mutate it. A simple constructor would be <em>approaching</em> too large, in my opinion.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>:=</span> <span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>NewSimple</span><span style=color:#c6d0f5>(</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>Resolution</span><span style=color:#c6d0f5>{</span><span style=color:#babbf1>Width</span><span style=color:#c6d0f5>:</span> 1920<span style=color:#c6d0f5>,</span> <span style=color:#babbf1>Weight</span><span style=color:#c6d0f5>:</span> 1080<span style=color:#c6d0f5>},</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6;font-style:italic>true</span><span style=color:#c6d0f5>,</span>
</span></span><span style=display:flex><span>	<span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>,</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>)</span>
</span></span></code></pre></div><h2 id=functional-options-pattern-in-go>Functional Options Pattern in Go</h2><p>Functional Options use <a href=https://gobyexample.com/variadic-functions>variadic functions</a> and <a href=https://en.wikipedia.org/wiki/First-class_function>first-class functions</a> to provide a more <a href=https://en.wikipedia.org/wiki/Fluent_interface>fluent-ish interface</a> for creating objects. It&rsquo;s a bit verbose, but also self-documenting without IDE hints.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>package</span> <span style=color:#babbf1>monitor_test</span>
</span></span><span style=display:flex><span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>:=</span> <span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>WithTech</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>),</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>WithResolution</span><span style=color:#c6d0f5>(</span>1920<span style=color:#c6d0f5>,</span> 1080<span style=color:#c6d0f5>),</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>WithStand</span><span style=color:#c6d0f5>,</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>)</span>
</span></span></code></pre></div><p>The <code>New</code> constructor loops over a list of mutator functions.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>package</span> <span style=color:#babbf1>monitor</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>func</span> <span style=color:#99d1db>New</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>options</span> <span style=color:#99d1db>...</span><span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>))</span> <span style=color:#c6d0f5>(</span><span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>,</span> <span style=color:#e5c890>error</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>m</span> <span style=color:#99d1db>:=</span> <span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>for</span> <span style=color:#babbf1>_</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>option</span> <span style=color:#99d1db>:=</span> <span style=color:#ca9ee6>range</span> <span style=color:#babbf1>options</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#99d1db>option</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#babbf1>m</span><span style=color:#c6d0f5>)</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>if</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>:=</span> <span style=color:#99d1db>validate</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#babbf1>m</span><span style=color:#c6d0f5>);</span> <span style=color:#babbf1>err</span> <span style=color:#99d1db>!=</span> <span style=color:#ca9ee6;font-style:italic>nil</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#ca9ee6>return</span> <span style=color:#ca9ee6;font-style:italic>nil</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>err</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>return</span> <span style=color:#99d1db>&amp;</span><span style=color:#babbf1>m</span><span style=color:#c6d0f5>,</span> <span style=color:#ca9ee6;font-style:italic>nil</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>func</span> <span style=color:#99d1db>validate</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>m</span> <span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#e5c890>error</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>if</span> <span style=color:#babbf1>m</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>tech</span> <span style=color:#99d1db>==</span> <span style=color:#a6d189>&#34;&#34;</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#ca9ee6>return</span> <span style=color:#babbf1>fmt</span><span style=color:#c6d0f5>.</span><span style=color:#99d1db>Errorf</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;tech is required&#34;</span><span style=color:#c6d0f5>)</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#626880;font-style:italic>// ... more validation here
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span>	<span style=color:#ca9ee6>return</span> <span style=color:#ca9ee6;font-style:italic>nil</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span></code></pre></div><p>The options functions are defined as follows. Note that they <em>return</em> a mutator function.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>func</span> <span style=color:#99d1db>WithTech</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>tech</span> <span style=color:#e5c890>string</span><span style=color:#c6d0f5>)</span> <span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>return</span> <span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>monitor</span> <span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>tech</span> <span style=color:#c6d0f5>=</span> <span style=color:#babbf1>tech</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>func</span> <span style=color:#99d1db>WithResolution</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>width</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>height</span> <span style=color:#e5c890>int</span><span style=color:#c6d0f5>)</span> <span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#ca9ee6>return</span> <span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>monitor</span> <span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>		<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span> <span style=color:#c6d0f5>=</span> <span style=color:#babbf1>Resolution</span><span style=color:#c6d0f5>{</span><span style=color:#babbf1>width</span><span style=color:#c6d0f5>,</span> <span style=color:#babbf1>height</span><span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span>	<span style=color:#c6d0f5>}</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span></code></pre></div><p>Options without arguments can be simplified, and simply <em>be</em> mutators instead of returning mutators. I usually don&rsquo;t do this as the interface becomes less consistent.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ca9ee6>var</span> <span style=color:#babbf1>WithoutStand</span> <span style=color:#c6d0f5>=</span> <span style=color:#ca9ee6>func</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>monitor</span> <span style=color:#99d1db>*</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span> <span style=color:#c6d0f5>{</span>
</span></span><span style=display:flex><span>	<span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>hasStand</span> <span style=color:#c6d0f5>=</span> <span style=color:#ca9ee6;font-style:italic>false</span>
</span></span><span style=display:flex><span><span style=color:#c6d0f5>}</span>
</span></span></code></pre></div><h2 id=creating-objects-in-rust>Creating objects in Rust</h2><p><em>Warning: Here be non-idiomatic beginner level Rust, and inaccurate explanations of Rust concepts.</em></p><h3 id=struct-literals>Struct literals</h3><p>Simple, clean and easy. However, it lacks validation, and fields must be public.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>mod</span> <span style=color:#e5c890>monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#8caaee;font-style:italic>#[derive(Debug)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#e5c890>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#8caaee;font-style:italic>#[derive(Debug)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>bool</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>main</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>monitor</span>::<span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>width</span>: 1920<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>height</span>: 1080<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>},</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>true</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#babbf1>println!</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;{:?}&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>)</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><h3 id=constructor>Constructor</h3><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>mod</span> <span style=color:#e5c890>monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#626880;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>    
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#8caaee;font-style:italic>#[derive(Debug)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#626880;font-style:italic>// no longer pub
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>        </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>bool</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>bool</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5;font-style:italic>Result</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>tech</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>resolution</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>has_stand</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>if</span><span style=color:#414559> </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Err</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>e</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>validate</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#ca9ee6>return</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Err</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>e</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5;font-style:italic>Ok</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>)</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>validate</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5;font-style:italic>Result</span><span style=color:#99d1db>&lt;</span><span style=color:#c6d0f5>(),</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>if</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>tech</span><span style=color:#414559> </span><span style=color:#99d1db>==</span><span style=color:#414559> </span><span style=color:#a6d189>&#34;&#34;</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#ca9ee6>return</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Err</span><span style=color:#c6d0f5>(</span><span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;tech field is empty&#34;</span><span style=color:#c6d0f5>));</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>}</span><span style=color:#414559> </span><span style=color:#626880;font-style:italic>// ... more validations here
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>        </span><span style=color:#c6d0f5;font-style:italic>Ok</span><span style=color:#c6d0f5>(())</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>main</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: 1920<span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: 1080<span style=color:#414559> </span><span style=color:#c6d0f5>},</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6;font-style:italic>true</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#babbf1>println!</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;{:?}&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><h2 id=functional-options-in-rust>Functional Options in Rust</h2><p>Let&rsquo;s implement the options pattern in Rust. I started with the following skeleton:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8caaee;font-style:italic>#![allow(dead_code, unused_variables)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>mod</span> <span style=color:#e5c890>monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#626880;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>	
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>todo!</span><span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#626880;font-style:italic>// has to be Vec since length cannot be determined
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>	</span><span style=color:#626880;font-style:italic>// at compile time.
</span></span></span><span style=display:flex><span><span style=color:#626880;font-style:italic></span><span style=color:#414559>	</span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>options</span>: <span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>OptionFn</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#99d1db>..</span><span style=color:#c6d0f5>.</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#ca9ee6>for</span><span style=color:#414559> </span><span style=color:#babbf1>option_fn</span><span style=color:#414559> </span><span style=color:#ca9ee6>in</span><span style=color:#414559> </span><span style=color:#babbf1>options</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>			</span><span style=color:#babbf1>option_fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>monitor</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_stand</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>todo!</span><span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>main</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>monitor</span>::<span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>width</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>height</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>},</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>false</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_stand</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#babbf1>println!</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;{:?}&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><h3 id=with_stand>with_stand</h3><p>Starting simple, I first made a <code>with_stand</code> function that mutates an existing object.</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_stand</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span> <span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5>()</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>has_stand</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#ca9ee6;font-style:italic>true</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#99d1db>..</span><span style=color:#c6d0f5>.</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_stand</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span></code></pre></div><p>This works fine, as shown by the output:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>tech</span>: <span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: 0<span style=color:#414559> </span><span style=color:#c6d0f5>},</span><span style=color:#414559> </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>true</span><span style=color:#414559> </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><h3 id=new>new</h3><p>First attempt at a constructor that takes a list of options:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>options</span>: <span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>OptionFn</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>			</span><span style=color:#babbf1>width</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>			</span><span style=color:#babbf1>height</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#c6d0f5>},</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>false</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#ca9ee6>for</span><span style=color:#414559> </span><span style=color:#babbf1>option_fn</span><span style=color:#414559> </span><span style=color:#ca9ee6>in</span><span style=color:#414559> </span><span style=color:#babbf1>options</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>option_fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><p>Rust has multiple function types, and only some of them can hold <a href=https://en.wikipedia.org/wiki/Closure_(computer_programming)>closures</a>.</p><ul><li><a href=https://doc.rust-lang.org/std/primitive.fn.html>Primitive Type <code>fn</code></a>. Function pointer. Simplest, cannot hold a closure.</li><li><a href=https://doc.rust-lang.org/std/ops/trait.Fn.html>Trait: <code>Fn</code></a>. Like <code>fn</code>, but can also hold closures which &ldquo;only take immutable references to captured variables&rdquo;. Can contain <code>fn</code>. Can be used instead of <code>FnMut</code> and <code>FnOnce</code>.</li><li><a href=https://doc.rust-lang.org/std/ops/trait.FnMut.html>Trait: <code>FnMut</code></a>. Like <code>Fn</code>, but can take mutable references to captured variables. Meaning that calling the function could mutate the captured variables. This again means that calling the function is a mutation, so a caller is only allowed to call the function if it is owned or mutably borrowed.</li><li><a href=https://doc.rust-lang.org/std/ops/trait.FnOnce.html>Trait: <code>FnOnce</code></a>. Like <code>Fn</code> and <code>FnMut</code>, but can only be called once. <code>Fn</code> or <code>FnMut</code> can be used instead of <code>FnOnce</code>. It could mutate captured variables, but it doesn&rsquo;t matter since nobody is allowed to access them afterwards.</li></ul><p>This seems to work just fine:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>vec!</span><span style=color:#c6d0f5>[</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_stand</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>]);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>println!</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;{:?}&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#626880;font-style:italic>// Monitor { ..., has_stand: true }
</span></span></span></code></pre></div><h3 id=with_resolution>with_resolution</h3><p><strong>First attempt</strong>:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_resolution</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>w</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>h</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>vec!</span><span style=color:#c6d0f5>[</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_stand</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_resolution</span><span style=color:#c6d0f5>(</span>1920<span style=color:#c6d0f5>,</span><span style=color:#414559> </span>1080<span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>]);</span><span style=color:#414559>
</span></span></span></code></pre></div><p>Compiler error, as expected:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#babbf1>error</span><span style=color:#c6d0f5>[</span><span style=color:#babbf1>E0308</span><span style=color:#c6d0f5>]</span>: <span style=color:#e5c890>mismatched</span><span style=color:#414559> </span><span style=color:#babbf1>types</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>  </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#e5c890>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:41:9<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>40<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>       </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_resolution</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>w</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>h</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>                                                 </span><span style=color:#99d1db>--------</span><span style=color:#414559> </span><span style=color:#babbf1>expected</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#ca9ee6>for</span><span style=color:#99d1db>&lt;&#39;</span><span style=color:#e5c890>a</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;&#39;</span><span style=color:#e5c890>a</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>because</span><span style=color:#414559> </span><span style=color:#babbf1>of</span><span style=color:#414559> </span><span style=color:#ca9ee6>return</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span>
</span></span><span style=display:flex><span>41<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>/</span><span style=color:#414559>         </span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>42<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>             </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>43<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>         </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#babbf1>_________</span><span style=color:#99d1db>^</span><span style=color:#414559> </span><span style=color:#babbf1>expected</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>pointer</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>found</span><span style=color:#414559> </span><span style=color:#babbf1>closure</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>note</span>: <span style=color:#e5c890>expected</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>pointer</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#ca9ee6>for</span><span style=color:#99d1db>&lt;&#39;</span><span style=color:#e5c890>a</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;&#39;</span><span style=color:#e5c890>a</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>                 </span><span style=color:#babbf1>found</span><span style=color:#414559> </span><span style=color:#babbf1>closure</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#c6d0f5>[</span><span style=color:#babbf1>closure</span><span style=color:#99d1db>@</span><span style=color:#babbf1>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:41:9: 41:32<span style=color:#c6d0f5>]</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>note</span>: <span style=color:#e5c890>closures</span><span style=color:#414559> </span><span style=color:#babbf1>can</span><span style=color:#414559> </span><span style=color:#babbf1>only</span><span style=color:#414559> </span><span style=color:#babbf1>be</span><span style=color:#414559> </span><span style=color:#babbf1>coerced</span><span style=color:#414559> </span><span style=color:#babbf1>to</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#ca9ee6>fn</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>types</span><span style=color:#414559> </span><span style=color:#ca9ee6>if</span><span style=color:#414559> </span><span style=color:#babbf1>they</span><span style=color:#414559> </span><span style=color:#ca9ee6>do</span><span style=color:#414559> </span><span style=color:#babbf1>not</span><span style=color:#414559> </span><span style=color:#babbf1>capture</span><span style=color:#414559> </span><span style=color:#babbf1>any</span><span style=color:#414559> </span><span style=color:#babbf1>variables</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>  </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#e5c890>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:42:54<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>42<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>             </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>                                                      </span><span style=color:#99d1db>^</span><span style=color:#414559>          </span><span style=color:#99d1db>^</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#babbf1>h</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>captured</span><span style=color:#414559> </span><span style=color:#babbf1>here</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>                                                      </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>                                                      </span><span style=color:#e78284>`</span><span style=color:#babbf1>w</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>captured</span><span style=color:#414559> </span><span style=color:#babbf1>here</span><span style=color:#414559>
</span></span></span></code></pre></div><p>What does this even mean?</p><p>First, <code>with_resolution</code> no longer returns a simple function pointer. It is now a closure, since it <em>captures</em> the variables <code>w</code> and <code>h</code>. These aren&rsquo;t static, since they are different for different instances of the function, and cannot be determined at compile time. <code>with_resolution(1920, 1080)</code> has captured (1920, 1080), while <code>with_resolution(640, 480)</code> has captured (640, 480). Clearly both of the returned functions cannot refer to the same data. Think of a closure like a primitive function combined with a <em>record</em> of captured variables. With this in mind, I understand what this means: <code>closures can only be coerced to </code>fn<code> types if they do not capture any variables</code>.</p><p>I&rsquo;m still having a hard time understanding the lifetime syntax <code>for&lt;'a> fn(&'a mut Monitor)</code> but I&rsquo;ll ignore that for now, since I will need closures anyways, and that type seems to be for primitive function pointers.</p><p><strong>Second attempt</strong>:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span></code></pre></div><p>The compiler now complains that &ldquo;trait objects must include the <code>dyn</code> keyword&rdquo;, and suggests adding <code>dyn</code> in front of <code>Fn</code>. So what&rsquo;s a <code>dyn</code>?</p><ul><li><a href=https://doc.rust-lang.org/std/keyword.dyn.html>Keyword <code>dyn</code></a>. It is used to highlight that calls to methods on the associated trait are dynamically dispatched.</li><li><a href=https://en.wikipedia.org/wiki/Dynamic_dispatch>Dynamic dispatch</a>. Which implementation of a polymorphic method or function to call is determined at run time. This is commonly used in object-oriented programming where similar objects can both implement an interface. For example, a <code>Duck</code>&rsquo;s <code>talk</code> method could output <code>quack quack</code> and a <code>Dog</code>&rsquo;s <code>talk</code> method could output <code>woof woof</code>. But if either are assigned to a variable of type <code>Animal</code> we no longer know which method to call during compile time. We have to do a &ldquo;dynamic dispatch&rdquo;, meaning that we look up the object&rsquo;s type, and call the correct <code>talk</code> method.</li><li><a href=https://doc.rust-lang.org/book/ch10-02-traits.html>Traits</a>. Traits are interfaces and define a behaviour an object must implement. If any type implements <code>talk()->()</code> we could say that it &ldquo;implements the <code>Talk</code> trait&rdquo;.</li><li><a href=https://doc.rust-lang.org/book/ch17-02-trait-objects.html>Trait objects</a>. &ldquo;Trait objects point to both an instance of a type implementing a trait, and a table used to look up traits method on that type at runtime.&rdquo;.</li></ul><p>It seems that once the return type is a trait and no longer a concrete type, we need the same type-to-function mapping as in the OOP-example above.</p><p><strong>Third attempt</strong>:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#ca9ee6>dyn</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span></code></pre></div><p>Compiler error:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#babbf1>error</span><span style=color:#c6d0f5>[</span><span style=color:#babbf1>E0277</span><span style=color:#c6d0f5>]</span>: <span style=color:#e5c890>the</span><span style=color:#414559> </span><span style=color:#babbf1>size</span><span style=color:#414559> </span><span style=color:#ca9ee6>for</span><span style=color:#414559> </span><span style=color:#babbf1>values</span><span style=color:#414559> </span><span style=color:#babbf1>of</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e78284>`</span><span style=color:#c6d0f5>(</span><span style=color:#ca9ee6>dyn</span><span style=color:#414559> </span><span style=color:#ca9ee6>for</span><span style=color:#99d1db>&lt;&#39;</span><span style=color:#e5c890>a</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;&#39;</span><span style=color:#e5c890>a</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span><span style=color:#99d1db>+</span><span style=color:#414559> </span><span style=color:#99d1db>&#39;</span><span style=color:#c6d0f5;font-style:italic>static</span><span style=color:#c6d0f5>)</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>cannot</span><span style=color:#414559> </span><span style=color:#babbf1>be</span><span style=color:#414559> </span><span style=color:#babbf1>known</span><span style=color:#414559> </span><span style=color:#babbf1>at</span><span style=color:#414559> </span><span style=color:#babbf1>compilation</span><span style=color:#414559> </span><span style=color:#babbf1>time</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#e5c890>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:20:25<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>20<span style=color:#414559>  </span><span style=color:#99d1db>|</span><span style=color:#414559>     </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>options</span>: <span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>OptionFn</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>|</span><span style=color:#414559>                         </span><span style=color:#99d1db>^^^^^^^^^^^^^</span><span style=color:#414559> </span><span style=color:#babbf1>doesn</span><span style=color:#99d1db>&#39;</span><span style=color:#e5c890>t</span><span style=color:#414559> </span><span style=color:#babbf1>have</span><span style=color:#414559> </span><span style=color:#babbf1>a</span><span style=color:#414559> </span><span style=color:#babbf1>size</span><span style=color:#414559> </span><span style=color:#babbf1>known</span><span style=color:#414559> </span><span style=color:#babbf1>at</span><span style=color:#414559> </span><span style=color:#babbf1>compile</span><span style=color:#99d1db>-</span><span style=color:#babbf1>time</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>help</span>: <span style=color:#e5c890>the</span><span style=color:#414559> </span><span style=color:#ca9ee6>trait</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#c6d0f5;font-style:italic>Sized</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>is</span><span style=color:#414559> </span><span style=color:#babbf1>not</span><span style=color:#414559> </span><span style=color:#babbf1>implemented</span><span style=color:#414559> </span><span style=color:#ca9ee6>for</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#c6d0f5>(</span><span style=color:#ca9ee6>dyn</span><span style=color:#414559> </span><span style=color:#ca9ee6>for</span><span style=color:#99d1db>&lt;&#39;</span><span style=color:#e5c890>a</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;&#39;</span><span style=color:#e5c890>a</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span><span style=color:#99d1db>+</span><span style=color:#414559> </span><span style=color:#99d1db>&#39;</span><span style=color:#c6d0f5;font-style:italic>static</span><span style=color:#c6d0f5>)</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>note</span>: <span style=color:#e5c890>required</span><span style=color:#414559> </span><span style=color:#babbf1>by</span><span style=color:#414559> </span><span style=color:#babbf1>a</span><span style=color:#414559> </span><span style=color:#babbf1>bound</span><span style=color:#414559> </span><span style=color:#ca9ee6>in</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#99d1db>/</span><span style=color:#babbf1>Users</span><span style=color:#99d1db>/</span><span style=color:#babbf1>aros</span><span style=color:#99d1db>/</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rustup</span><span style=color:#99d1db>/</span><span style=color:#babbf1>toolchains</span><span style=color:#99d1db>/</span><span style=color:#babbf1>nightly</span><span style=color:#99d1db>-</span><span style=color:#babbf1>aarch64</span><span style=color:#99d1db>-</span><span style=color:#babbf1>apple</span><span style=color:#99d1db>-</span><span style=color:#babbf1>darwin</span><span style=color:#99d1db>/</span><span style=color:#babbf1>lib</span><span style=color:#99d1db>/</span><span style=color:#babbf1>rustlib</span><span style=color:#99d1db>/</span><span style=color:#babbf1>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>rust</span><span style=color:#99d1db>/</span><span style=color:#babbf1>library</span><span style=color:#99d1db>/</span><span style=color:#babbf1>alloc</span><span style=color:#99d1db>/</span><span style=color:#babbf1>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>vec</span><span style=color:#99d1db>/</span><span style=color:#ca9ee6>mod</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:396:16<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>396<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>T</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#8caaee;font-style:italic>#[unstable(feature = </span><span style=color:#a6d189>&#34;allocator_api&#34;</span><span style=color:#8caaee;font-style:italic>, issue = </span><span style=color:#a6d189>&#34;32838&#34;</span><span style=color:#8caaee;font-style:italic>)]</span><span style=color:#414559> </span><span style=color:#babbf1>A</span>: <span style=color:#e5c890>Allocator</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Global</span><span style=color:#99d1db>&gt;</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#99d1db>|</span><span style=color:#414559>                </span><span style=color:#99d1db>^</span><span style=color:#414559> </span><span style=color:#babbf1>required</span><span style=color:#414559> </span><span style=color:#babbf1>by</span><span style=color:#414559> </span><span style=color:#babbf1>this</span><span style=color:#414559> </span><span style=color:#babbf1>bound</span><span style=color:#414559> </span><span style=color:#ca9ee6>in</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span></code></pre></div><p>The problem this time seems to be that after allowing <code>OptionFn</code>s to hold closures, items no longer have a static size, and <code>Vec</code> requires each item to have a size that can be determined at compilation time. Some quick googling recommends wrapping <code>dyn Fn(&mut Monitor) -> ()</code> in a <code>Box</code>.</p><ul><li><a href=https://doc.rust-lang.org/std/boxed/struct.Box.html>Box</a>. A pointer type that uniquely owns a heap allocation of type <code>T</code>. Used when size isn&rsquo;t known at compile time, when you want to transfer ownership of heap data, and &ldquo;<a href=https://doc.rust-lang.org/book/ch15-01-box.html>When you want to own a value and you care only that it’s a type that implements a particular trait rather than being of a specific type</a>&rdquo;. This seems to be closely related to <a href=https://doc.rust-lang.org/book/ch17-02-trait-objects.html#using-trait-objects-that-allow-for-values-of-different-types>Trait Objects</a>.</li></ul><p><strong>Fourth attempt</strong>. I had to convert <code>with_stand</code> so that it returns a boxed primitive function pointer (<code>fn</code> implements <code>Fn</code>).</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Box</span><span style=color:#99d1db>&lt;</span><span style=color:#ca9ee6>dyn</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#c6d0f5>()</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_stand</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>has_stand</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#ca9ee6;font-style:italic>true</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_resolution</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>w</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>h</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><p>Progress is a new compiler error.
<strong>error(<a href=https://doc.rust-lang.org/error_codes/E0373.html>E0373</a>): closure may outlive the current function, but it borrows <code>w</code>, which is owned by the current function</strong></p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#414559>  </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#e5c890>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:43:18<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>43<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>          </span><span style=color:#99d1db>^^^^^^^^^^^^^^^^^^^^^^^</span><span style=color:#414559> </span><span style=color:#babbf1>may</span><span style=color:#414559> </span><span style=color:#babbf1>outlive</span><span style=color:#414559> </span><span style=color:#babbf1>borrowed</span><span style=color:#414559> </span><span style=color:#babbf1>value</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#babbf1>w</span><span style=color:#e78284>`</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>44<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>     </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>                                              </span><span style=color:#99d1db>-</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#babbf1>w</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>is</span><span style=color:#414559> </span><span style=color:#babbf1>borrowed</span><span style=color:#414559> </span><span style=color:#babbf1>here</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>note</span>: <span style=color:#e5c890>closure</span><span style=color:#414559> </span><span style=color:#babbf1>is</span><span style=color:#414559> </span><span style=color:#babbf1>returned</span><span style=color:#414559> </span><span style=color:#babbf1>here</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>  </span><span style=color:#99d1db>-</span>-&gt; <span style=color:#e5c890>src</span><span style=color:#99d1db>/</span><span style=color:#babbf1>main</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>rs</span>:43:9<span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>43<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>/</span><span style=color:#414559>     </span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>44<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>         </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>45<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>     </span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#babbf1>______</span><span style=color:#99d1db>^</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#babbf1>help</span>: <span style=color:#e5c890>to</span><span style=color:#414559> </span><span style=color:#babbf1>force</span><span style=color:#414559> </span><span style=color:#babbf1>the</span><span style=color:#414559> </span><span style=color:#babbf1>closure</span><span style=color:#414559> </span><span style=color:#babbf1>to</span><span style=color:#414559> </span><span style=color:#babbf1>take</span><span style=color:#414559> </span><span style=color:#babbf1>ownership</span><span style=color:#414559> </span><span style=color:#babbf1>of</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#babbf1>w</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>and</span><span style=color:#414559> </span><span style=color:#babbf1>any</span><span style=color:#414559> </span><span style=color:#babbf1>other</span><span style=color:#414559> </span><span style=color:#babbf1>referenced</span><span style=color:#414559> </span><span style=color:#babbf1>variables</span><span style=color:#c6d0f5>),</span><span style=color:#414559> </span><span style=color:#ca9ee6>use</span><span style=color:#414559> </span><span style=color:#babbf1>the</span><span style=color:#414559> </span><span style=color:#e78284>`</span><span style=color:#ca9ee6>move</span><span style=color:#e78284>`</span><span style=color:#414559> </span><span style=color:#babbf1>keyword</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span>43<span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#414559>     </span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#ca9ee6>move</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>   </span><span style=color:#99d1db>|</span><span style=color:#414559>              </span><span style=color:#99d1db>++++</span><span style=color:#414559>
</span></span></span></code></pre></div><p>What does it mean that the &ldquo;closure may outlive the current function&rdquo;? When we called <code>with_resolution(w, h)</code>, ownership of <code>w</code> and <code>h</code> was transferred to <code>with_resolution</code>. They are stored on the <em>stack</em> and will be destroyed when the function returns. That is a problem since the returned closure still depend on them. The solution is to transfer the ownership of the variables <em>to the closure</em> before returning. As suggested, this is done using <code>move</code>.</p><p><strong>Fifth attempt: Success</strong>
Adding <code>move</code> did the trick. The implementation so far:</p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>mod</span> <span style=color:#e5c890>monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#8caaee;font-style:italic>#[derive(Debug)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#e5c890>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#8caaee;font-style:italic>#[derive(Debug)]</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>struct</span> <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>bool</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>type</span> <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Box</span><span style=color:#99d1db>&lt;</span><span style=color:#ca9ee6>dyn</span><span style=color:#414559> </span><span style=color:#c6d0f5;font-style:italic>Fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#c6d0f5>)</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>options</span>: <span style=color:#c6d0f5;font-style:italic>Vec</span><span style=color:#99d1db>&lt;</span><span style=color:#babbf1>OptionFn</span><span style=color:#99d1db>&gt;</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>resolution</span>: <span style=color:#e5c890>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>                </span><span style=color:#babbf1>width</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>                </span><span style=color:#babbf1>height</span>: 0<span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#c6d0f5>},</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>has_stand</span>: <span style=color:#e5c890>false</span><span style=color:#c6d0f5>,</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>tech</span>: <span style=color:#c6d0f5;font-style:italic>String</span>::<span style=color:#babbf1>from</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;&#34;</span><span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#ca9ee6>for</span><span style=color:#414559> </span><span style=color:#babbf1>option_fn</span><span style=color:#414559> </span><span style=color:#ca9ee6>in</span><span style=color:#414559> </span><span style=color:#babbf1>options</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>option_fn</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>&amp;</span><span style=color:#ca9ee6>mut</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>monitor</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_stand</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>has_stand</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#ca9ee6;font-style:italic>true</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_resolution</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>w</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>h</span>: <span style=color:#e5c890>u16</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#ca9ee6>move</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>            </span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>resolution</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>Resolution</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559> </span><span style=color:#babbf1>width</span>: <span style=color:#e5c890>w</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>height</span>: <span style=color:#e5c890>h</span><span style=color:#414559> </span><span style=color:#c6d0f5>};</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>main</span><span style=color:#c6d0f5>()</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>vec!</span><span style=color:#c6d0f5>[</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_stand</span><span style=color:#c6d0f5>(),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>        </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_resolution</span><span style=color:#c6d0f5>(</span>1920<span style=color:#c6d0f5>,</span><span style=color:#414559> </span>1080<span style=color:#c6d0f5>),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#c6d0f5>]);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>    </span><span style=color:#babbf1>println!</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;{:?}&#34;</span><span style=color:#c6d0f5>,</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#c6d0f5>);</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span></code></pre></div><h3 id=with_tech>with_tech</h3><p>There is also some Rust trickery here. Especially concerning<a href=https://blog.thoughtram.io/string-vs-str-in-rust/> <code>&str</code> vs <code>String</code>.</a></p><div class=highlight><pre tabindex=0 style=color:#ef9f76;background-color:#303446;-moz-tab-size:3;-o-tab-size:3;tab-size:3><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#ca9ee6>pub</span><span style=color:#414559> </span><span style=color:#ca9ee6>fn</span> <span style=color:#99d1db>with_tech</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>tech</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>str</span><span style=color:#c6d0f5>)</span><span style=color:#414559> </span>-&gt; <span style=color:#e5c890>OptionFn</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>tech</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>tech</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>to_string</span><span style=color:#c6d0f5>();</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5;font-style:italic>Box</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#ca9ee6>move</span><span style=color:#414559> </span><span style=color:#99d1db>|</span><span style=color:#babbf1>monitor</span>: <span style=color:#ca9ee6;font-weight:700>&amp;</span><span style=color:#e5c890>mut</span><span style=color:#414559> </span><span style=color:#babbf1>Monitor</span><span style=color:#99d1db>|</span><span style=color:#414559> </span><span style=color:#c6d0f5>{</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>		</span><span style=color:#babbf1>monitor</span><span style=color:#c6d0f5>.</span><span style=color:#babbf1>tech</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>tech</span><span style=color:#c6d0f5>;</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#c6d0f5>})</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>}</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#ca9ee6>let</span><span style=color:#414559> </span><span style=color:#babbf1>mon</span><span style=color:#414559> </span><span style=color:#99d1db>=</span><span style=color:#414559> </span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>new</span><span style=color:#c6d0f5>(</span><span style=color:#babbf1>vec!</span><span style=color:#c6d0f5>[</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#99d1db>..</span><span style=color:#c6d0f5>.</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559>	</span><span style=color:#babbf1>monitor</span>::<span style=color:#babbf1>with_tech</span><span style=color:#c6d0f5>(</span><span style=color:#a6d189>&#34;OLED&#34;</span><span style=color:#c6d0f5>)),</span><span style=color:#414559>
</span></span></span><span style=display:flex><span><span style=color:#414559></span><span style=color:#c6d0f5>]);</span><span style=color:#414559>
</span></span></span></code></pre></div><p>String literals, for example &ldquo;OLED&rdquo; are stored in a special read-only section of the compiled executable. <code>with_tech</code> takes a pointer to that string. It has a <code>static</code> lifetime (i.e. lives for the entire duration of the program).</p><p><code>to_string</code> is used to get ownership of the input string.</p><h2 id=conclusion>Conclusion</h2><p>The options pattern seems completely viable in Rust, and my fight with the borrow checker forced me to learn more about how closures are implemented.</p><p>If you have any feedback or corrections, feel free <a href=https://www.reddit.com/r/learnrust/comments/13zhnjj/functional_options_pattern_in_go_and_rust/>to comment</a> or shoot me an email.</p><h3 id=code-and-references>Code and references</h3><ul><li><a href=https://github.com/roessland/learn-rust/blob/main/patterns/functional-options-pattern/go-3-options/monitor/3.go>Go implementation</a></li><li><a href=https://github.com/roessland/learn-rust/blob/main/patterns/functional-options-pattern/rs-3-options-again/src/main.rs>Rust implementation</a></li><li><a href=https://rust-unofficial.github.io/patterns/patterns/creational/builder.html>Rust Design Patterns: Builder Pattern</a></li><li><a href=https://crates.io/crates/derive_builder>Builder Pattern Derive macro crate</a></li><li><a href=https://deterministic.space/elegant-apis-in-rust.html>Elegant APIs in Rust</a></li></ul><ul class=pa0><li class="list di"><a href=/tags/go class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">go</a></li><li class="list di"><a href=/tags/rust class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">rust</a></li><li class="list di"><a href=/tags/programming class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">programming</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this blog</p><nav id=TableOfContents><ul><li><ul><li><a href=#creating-objects-in-go>Creating objects in Go</a></li><li><a href=#functional-options-pattern-in-go>Functional Options Pattern in Go</a></li><li><a href=#creating-objects-in-rust>Creating objects in Rust</a></li><li><a href=#functional-options-in-rust>Functional Options in Rust</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/advent-of-code-2022/11/>Advent of Code 2022 Day 11: Monkey in the Middle</a></li><li class=mb2><a href=/blog/advent-of-code-2022/07/>Advent of Code 2022 Day 7: No Space Left On Device</a></li><li class=mb2><a href=/blog/advent-of-code-2022/05/>Advent of Code 2022 Day 5: Supply Stacks</a></li><li class=mb2><a href=/blog/advent-of-code-2022/04/>Advent of Code 2022 Day 4: Camp Cleanup</a></li><li class=mb2><a href=/blog/advent-of-code-2022/03/>Advent of Code 2022 Day 3: Rucksack Reorganization</a></li><li class=mb2><a href=/blog/advent-of-code-2022/02/>Advent of Code 2022 Day 2: Rock Paper Scissors</a></li><li class=mb2><a href=/blog/advent-of-code-2022/01/>Advent of Code 2022 Day 1: Calorie Counting</a></li><li class=mb2><a href=/blog/advent-of-code-2022/>Advent of Code 2022</a></li><li class=mb2><a href=/blog/advent-of-code-2021/24/>Advent of Code 2021 Day 24: Arithmetic Logic Unit</a></li><li class=mb2><a href=/blog/advent-of-code-2021/22/>Advent of Code 2021 Day 22: Reactor Reboot</a></li><li class=mb2><a href=/blog/advent-of-code-2021/21/>Advent of Code 2021 Day 21: Dirac Dice</a></li><li class=mb2><a href=/blog/advent-of-code-2021/18/>Advent of Code 2021 Day 18: Snailfish</a></li><li class=mb2><a href=/blog/advent-of-code-2021/16/>Advent of Code 2021 Day 16: Packet Decoder</a></li><li class=mb2><a href=/blog/advent-of-code-2021/15/>Advent of Code 2021 Day 15: Chiton</a></li><li class=mb2><a href=/blog/advent-of-code-2021/14/>Advent of Code 2021 Day 14: Extended Polymerization</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.roessland.com/>&copy; Andreas Røssland 2023</a><div><div class=ananke-socials><a href=https://github.com/roessland target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg enable-background="new 0 0 512 512" height="50" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>